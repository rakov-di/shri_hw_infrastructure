## Содержание <a name = "content_table"></a>

- [Описание домашки по инфраструктуре](#about)
- [Начало работы](#getting_started)
- [Структура файлов](#file_tree)
- [Возможные проблемы](#problems)
- [TODO](#todo)

## Описание домашки по Инфраструктуре <a name = "about"></a>

Версия Node JS - 11.6.0

Билд-сервер умеет:
 - подниматься (кстати, полезный навык, мне вот не всегда удается)
 - запрашивать из api БД текущие настройки репозитория и список билдов (при ошибках либо если в списке билдов нет билдов со статусом Waiting - повторять запросы)
 - ожидать билд-агент на ручке `/notify` и регистрировать их при обращении
 - назначать билд-агенту задачу (если билд-агент не отвечает - искать следующего)
 - отправлять билд-агенту задачу на ручку `/build`, добавлять инфу об этом в БД через ручку `/start`
 - принимать результата работы от билд-агента, обновлять инфу в БД о билде через ручку `/finish`
 - билд-сервер запрашивает из БД новый билд-лист ТОЛЬКО после того, как все задачи из ранее полученнного билда будут завершены или хотя бы назначены билд-агентам (т.е. попробовал уменьшить кол-во обращений к БД)
 
 Билд-сервер не умеет:
 - Пинговать билд-агенты во время выполнения ими задачи и обрабатывать ситуации, кодга билд-агент падает при выполнении
 - После собственного падения и восстановления - принимать билды от билд-агента (хотя билд-агенты умеют слать ему билды, он может их получить, НО не обработать) 
 
Билд-агент умеет: 
 - подниматься 
 - стучаться к билд-серверу на ручку билд-сервера `/notify` (при ошибках - повторять запросы)
 - получать билд на свою ручку `/build`
 - клонировать (или пулить если уже склонирован) репозиторий, делать билд
 - отправлять результаты билда на ручку билд-сервера `/notify-build-result` (при ошибках - повторять запросы)
 
 Не стал убирать консоль-логи, т.к. кажется, с ними будет проще понять логику работы сервера и агента. 

Вернуться [К содержанию](#content_table)

## Начало работы <a name = "getting_started"></a>

Для запуска приложения необходимо:
- В папке [build-server](server) переименовать файл с примером конфигурации [server-conf.example.json](server/server-conf.example.json) в `server-conf.json`.
В поле `apiToken` подставьте ваш токен авторизации (его можно получить по [фейковой сссылке](README.MD))
- Запустить билд-сервер:
```bash
cd build-server && npm ci && npm start
```

- Запустить билд-агент:
```bash
cd build-agent && npm ci && npm start
```

Добавить в [апи БД](https://hw.shri.yandex/api/index.html) настройки репозитория и коммиты для сборки.

Вернуться [К содержанию](#content_table)

## Структура файлов <a name = "file_tree"></a>

Структура билд-сервера и билд-агента похожи.
- build-server
    - app.js - точка всхода
    - server-conf.js - основные настройки
    - build-server/router - маршрутизация зарпросов, приходящих на торчащие наружу ручки
    - build-server/api - апи для обращения наружу (к апи БД и ручкам билд-агента)
    - build-server/controllers - обработчики обращений к своим и сторонним апи
    - build-server/utils - вспомогательные утилиты
    - build-server/storage - хранилище информации о билдах и агентах (на самом деле, немножно помойка, надеюсь, разобраться с логикой, часть перекинуть в контроллеры, часть упростить)
- build-agent
    - app.js - точка всхода
    - agent-conf.js - основные настройки
    - build-server/router - маршрутизация зарпросов, приходящих на торчащие наружу ручки
    - build-server/api - апи для обращения наружу (к ручкам билд-сервера)
    - build-server/controllers - обработчики обращений к своим и сторонним апи
    - build-server/utils - вспомогательные утилиты

Вернуться [К содержанию](#content_table)

## Возможные проблемы <a name = "problems"></a>

Убедитесь, что используемые билд-сервером и билд-агентами порты (8000, 9000, 9001 и т.д.) не заняты другими программами.

## TODO <a name = "todo"></a>
- Научить билд-сервер
    - обрабатывать ситуации, когда билд-агент прекратил работать во время сборки
    - обрабатыват результаты билдов полученнные после падения/восстановления самого билд-сервера (возможно, для это стоит перенести его локальное хранилище из оперативной памяти хотя бы в лог-файлы)
- Создать еще одного билд-агента, проверить насколько эффективно билд-сервер распределят задачи между билд агентами
- подготовить докер-образы
    
Вернуться [К содержанию](#content_table)
